#!/usr/bin/env python
from __future__ import annotations

import argparse
import json
import os
import string
from pathlib import Path

repo_simflow = ("git@github.com:legend-exp/legend-simflow.git", "main")
repo_metadata = ("https://github.com/legend-exp/legend-metadata.git", "main")


def main():
    # check existence of env vars
    if not os.getenv("PRODENV"):
        msg = "source setup.sh before continuing"
        raise RuntimeError(msg)

    parser = argparse.ArgumentParser(description="Initialize a new production cycle")
    parser.add_argument(
        "rpath",
        help="relative path of directory in which the production cycle will be created",
        default="",
    )
    args = parser.parse_args()

    path_cycle = Path(os.getenv("PRODENV")) / args.rpath
    path_cycle.mkdir(parents=True)

    # Create json config file
    config_file = {
        "setups": {
            "l200a": {
                "paths": {
                    "simflow": "$_/workflow",
                    "metadata": "$_/inputs",
                    "config": "$_/inputs/simprod/config",
                    "tier_mac": "$_/generated/tier/ver",
                    "tier_raw": "$_/generated/tier/raw",
                    "tier_evt": "$_/generated/tier/evt",
                    "tier_pdf": "$_/generated/tier/pdf",
                    "macros": "$_/generated/macros",
                    "plt": "$_/generated/plt",
                    "log": "$_/generated/log",
                    "src": "$_/software/python/src",
                    "install": "$_/software/python/install",
                    "cache": "$_/software/python/cache",
                },
                "filetypes": {
                    "input": {
                        "ver": ".mac",
                        "raw": ".mac",
                        "evt": ".root",
                        "pdf": ".root",
                    },
                    "output": {
                        "ver": ".root",
                        "raw": ".root",
                        "evt": ".root",
                        "pdf": ".root",
                    },
                },
                "runcmd": {
                    "ver": "MaGe {input} &> {log}",
                    "raw": "MaGe {input} &> {log}",
                    "evt": "mage-post-proc {} &> {log}",
                    "pdf": "{} &> {log}",
                },
                "execenv": {
                    "cmd": "shifter",
                    "arg": "--image=legendexp/legend-base:private",
                },
            }
        }
    }

    with Path.open(path_cycle / "config.json", "w") as outfile:
        json.dump(config_file, outfile, ensure_ascii=False, indent=4)

    tmp_path = config_file["setups"]["l200a"]["paths"]["simflow"]
    tmp_path = string.Template(tmp_path).substitute({"_": path_cycle})
    os.system(f"git clone {repo_simflow[0]} {tmp_path} --branch {repo_simflow[1]}")

    tmp_path = config_file["setups"]["l200a"]["paths"]["metadata"]
    tmp_path = string.Template(tmp_path).substitute({"_": path_cycle})
    os.system(
        f"git clone {repo_metadata[0]} {tmp_path} "
        f"--branch {repo_metadata[1]} --recurse-submodules"
    )


if __name__ == "__main__":
    main()
