#!/bin/bash

origdir=$(pwd)
mkdir -p "$PRODENV/tools/bin"
cd "$PRODENV/tools" || exit

system="$(uname)-$(uname -m)"

# install mamba
curl -LO "https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$system.sh"
bash "Mambaforge-$system.sh" -b -u -p snakemake-mambaforge3/

# create mamba env with snakemake
snakemake-mambaforge3/bin/mamba create --yes \
    --name snakemake \
    --channel conda-forge \
    --channel bioconda \
    -- snakemake-minimal panoptes-ui jinja2

# make exes visible
ln -fs ../snakemake-mambaforge3/envs/snakemake/bin/snakemake bin/
ln -fs ../snakemake-mambaforge3/envs/snakemake/bin/python3 bin/python3-snakemake
ln -fs ../snakemake-mambaforge3/envs/snakemake/bin/panoptes bin/

# cleanup
rm "Mambaforge-$system.sh"
cd "$origdir" || exit
